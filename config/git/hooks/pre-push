#!/bin/bash

# Redirect output to stderr.
exec 1>&2

read -p "Press enter to review with Claude, n to skip) [$0] " -n 1 -r < /dev/tty
echo
if [[ $REPLY =~ ^[Nn]$ ]]; then
  exit 0
fi

REVIEW_BRANCH=$(git rev-parse --abbrev-ref @{upstream} 2>/dev/null)

if [[ -z "$REVIEW_BRANCH" ]]; then
  REVIEW_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
  if [[ -z "$REVIEW_BRANCH" ]]; then
    echo "Could not determine the remote branch to review against. [$0]"
  fi
  REVIEW_BRANCH="the default branch"
fi

echo "Reviewing changes against ${REVIEW_BRANCH}... [$0]"

claude "Review the changes on this branch against ${REVIEW_BRANCH}. Don't re-fetch the remote branch."

read -p "Press ENTER to continue with push... [$0]" < /dev/tty
exit 0
